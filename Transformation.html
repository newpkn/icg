<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>putPixel Demo</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        canvas {
            border: 1px solid black;
            image-rendering: pixelated;
            scale: 3;
            /* ขยายขนาด canvas */
        }
    </style>
</head>

<body>
    <canvas id="myCanvas" width="200" height="200"></canvas>
    <script>
        const spaceInvaderSprite = [
            [0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1],
            [0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1],
            [0, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1],
            [0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1],
            [0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1],
            [0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1],
            [0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1],
            [0, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 0],
            [1, 0, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1],
            [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
            [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
            [0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0],
            [0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0],
        ];
        const canvas = document.getElementById('myCanvas');
        const ctx = canvas.getContext('2d');

        // เตรียม buffer ขนาดเท่า canvas
        const imageData = ctx.createImageData(canvas.width, canvas.height);
        const data = imageData.data;

        // ฟังก์ชัน putPixel
        function putPixel(x, y, r, g, b, a) {
            const index = ((-y + canvas.height / 2) * canvas.width + (x + canvas.width / 2)) * 4;
            data[index] = r;     // Red
            data[index + 1] = g; // Green
            data[index + 2] = b; // Blue
            data[index + 3] = a; // Alpha
        }
        function drawLine(x1, y1, x2, y2, r, g, b, a) {
            const dx = x2 - x1;
            const dy = y2 - y1;
            const steps = Math.max(Math.abs(dx), Math.abs(dy));
            const xIncrement = dx / steps;
            const yIncrement = dy / steps;

            let x = x1;
            let y = y1;

            for (let i = 0; i <= steps; i++) {
                putPixel(Math.round(x), Math.round(y), r, g, b, a);
                x += xIncrement;
                y += yIncrement;
            }
        }
        function drawSprite(x, y, sprite, r, g, b, a,degree, scale) {
            for (let row = 0; row < sprite.length; row++) {
                for (let col = 0; col < sprite[row].length; col++) {
                    if (sprite[row][col] === 1) { // ถ้าเป็นพิกเซลที่ต้องวาด
                        let cX = col - (sprite[row].length / 2);
                        let cY = row + (sprite.length / 2);

                        const red = degree * Math.PI / 100;
                        const x_rot = Math.round(cX * Math.cos(red) - cY * Math.sin(red))
                        const y_rot = Math.round(cX * Math.sin(red) + cY * Math.cos(red))

                        const x_scaled = x_rot * scale;
                        const y_scaled = y_rot * scale;

                        putPixel(x+x_scaled, y-y_scaled, r, g, b, a); // วาดพิกเซล
                    }
                }
            }
        }
        function drawText(text, x, y, r, g, b, a) {
            const fontSize = 16;
            ctx.font = `${fontSize}px Arial`;
            ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${a / 255})`;
            ctx.fillText(text, x + canvas.width / 2, -y + canvas.height / 2 + fontSize / 2); // ปรับตำแหน่งให้ตรงกลาง
        }

        function clearCanvas() {
            data.fill(0); // ล้าง buffer ด้วยสีดำ
        }

        let objX = 50;
        let objY = 20;
        let transX = 0;
        let transY = 0;
        let degree = 0;
        let scale = 1;
        window.addEventListener('keydown', (event) => {
            switch (event.key) {
                case 'd':
                    transX = 1;
                    break;
                case 'a':
                    transX = -1;
                    break;
                case 'w':
                    transY = 1;
                    break;
                case 's':
                    transY = -1;
                    break;
                case 'q':
                    degree+=1;
                    break;
                case 'e':
                    degree-=1;
                    break;
                case 'z':
                    scale+=1;
                    break;
                case 'x':
                    scale-=1;
                    break;
            }
        });
        window.addEventListener('keyup', (event) => {
            switch (event.key) {
                case 'd':
                    transX = 0;
                    break;
                case 'a':
                    transX = 0;
                    break;
                case 'w':
                    transY = 0;
                    break;
                case 's':
                    transY = 0;
                    break;
            }
        });
        function animate() {
            clearCanvas();
            drawLine(0, 0, 90, 0, 0, 0, 0, 255); // เส้นแนวนอน
            drawLine(90, 0, 85, -5, 0, 0, 0, 255); // ลูกศร
            drawLine(90, 0, 85, 5, 0, 0, 0, 255); // ลูกศร

            drawLine(0, 90, 5, 85, 0, 0, 0, 255);
            drawLine(0, 90, -5, 85, 0, 0, 0, 255);

            drawLine(0, 0, 0, 90, 0, 0, 0, 255); // เส้นแนวตั้ง

            objX = objX + transX;
            objY = objY + transY;
            const red = degree * Math.PI / 100;
            const x_rot = Math.round(objX * Math.cos(red) - objY * Math.sin(red))
            const y_rot = Math.round(objX * Math.sin(red) + objY * Math.cos(red))
            // จุดเดิม สีแดง
            putPixel(x_rot, y_rot, 255, 0, 0, 255);
            drawSprite(objX,objY,spaceInvaderSprite,0,255,0,255,degree,scale);
            ctx.putImageData(imageData, 0, 0);
            drawText("degree: "+degree,0,-50,0,0,0,255);
            requestAnimationFrame(animate);
        }

        animate();
        // จุดเดิม

        // วาด buffer กลับไปที่ canvas
        ctx.putImageData(imageData, 0, 0);
    </script>
</body>

</html>